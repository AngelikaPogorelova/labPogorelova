import tkinter as tk
from tkinter import messagebox
import random

BOARD_SIZE = 10
SHIP_SIZES = [4,3,3,2,2,2,1,1,1,1]
player_board, bot_board = [], []
player_display, bot_display = [], []
player_buttons, bot_buttons = [], []
ships_to_place = SHIP_SIZES.copy()
placing_ships, current_turn, game_over = True, "player", False
bot_mode, bot_hits = "search", []

def create_board(): return [["~"]*BOARD_SIZE for _ in range(BOARD_SIZE)]
def can_place_ship(b,x,y,s,d):
    if d=="h" and y+s<=BOARD_SIZE:
        for i in range(max(0,x-1),min(BOARD_SIZE,x+2)):
            for j in range(max(0,y-1),min(BOARD_SIZE,y+s+1)):
                if b[i][j]!="~": return False
    elif d=="v" and x+s<=BOARD_SIZE:
        for i in range(max(0,x-1),min(BOARD_SIZE,x+s+1)):
            for j in range(max(0,y-1),min(BOARD_SIZE,y+2)):
                if b[i][j]!="~": return False
    else: return False
    return True
def place_ship(b,x,y,s,d):
    if not can_place_ship(b,x,y,s,d): return False
    for i in range(s):
        if d=="h": b[x][y+i]="S"
        else: b[x+i][y]="S"
    return True
def setup_bot_ships():
    for s in SHIP_SIZES:
        while True:
            x,y=random.randint(0,BOARD_SIZE-1),random.randint(0,BOARD_SIZE-1)
            d=random.choice(["h","v"])
            if place_ship(bot_board,x,y,s,d): break
def setup_player_random():
    global player_board, ships_to_place
    player_board=create_board()
    ships_to_place=SHIP_SIZES.copy()
    for s in SHIP_SIZES:
        while True:
            x,y=random.randint(0,BOARD_SIZE-1),random.randint(0,BOARD_SIZE-1)
            d=random.choice(["h","v"])
            if place_ship(player_board,x,y,s,d): break
    update_ui()

def is_hit(b,x,y): return b[x][y]=="S"
def is_ship_sunk(b,x,y,dsp):
    if b[x][y]!="X": return False
    v,s=set(),[(x,y)]
    while s:
        cx,cy=s.pop()
        if (cx,cy) in v: continue
        v.add((cx,cy))
        for dx,dy in [(0,1),(1,0),(0,-1),(-1,0)]:
            nx,ny=cx+dx,cy+dy
            if 0<=nx<BOARD_SIZE and 0<=ny<BOARD_SIZE and b[nx][ny]=="X": s.append((nx,ny))
    for cx,cy in v:
        for dx,dy in [(0,1),(1,0),(0,-1),(-1,0),(1,1),(1,-1),(-1,1),(-1,-1)]:
            nx,ny=cx+dx,cy+dy
            if 0<=nx<BOARD_SIZE and 0<=ny<BOARD_SIZE and b[nx][ny]=="S": return False
    for cx,cy in v:
        for dx,dy in [(0,1),(1,0),(0,-1),(-1,0),(1,1),(1,-1),(-1,1),(-1,-1)]:
            nx,ny=cx+dx,cy+dy
            if 0<=nx<BOARD_SIZE and 0<=ny<BOARD_SIZE and b[nx][ny]=="~": b[nx][ny]=dsp[nx][ny]="O"
    return True
def all_ships_sunk(b): return not any("S" in row for row in b)
def update_ui():
    for i in range(BOARD_SIZE):
        for j in range(BOARD_SIZE):
            c=player_board[i][j]
            bg="lightblue" if c=="S" else "red" if c=="X" else "lightgray" if c=="O" else "white"
            player_buttons[i][j].config(bg=bg)
            c=player_display[i][j]
            text="ðŸ’¥" if c=="X" else "â€¢" if c=="O" else ""
            bg="red" if c=="X" else "lightgray" if c=="O" else "lightcyan"
            bot_buttons[i][j].config(text=text,bg=bg,state="normal" if current_turn=="player" and not game_over and not placing_ships else "disabled")

def player_turn(x,y):
    global current_turn,game_over
    if game_over or player_display[x][y] in ["X","O"] or placing_ships: return
    hit=is_hit(bot_board,x,y)
    player_display[x][y]=bot_board[x][y]="X" if hit else "O"
    is_ship_sunk(bot_board,x,y,player_display)
    if all_ships_sunk(bot_board):
        messagebox.showinfo("ÐŸÐ¾Ð±ÐµÐ´Ð°!","ðŸŽ‰ Ð’Ñ‹ Ð¿Ð¾Ñ‚Ð¾Ð¿Ð¸Ð»Ð¸ Ð²ÑÐµ ÐºÐ¾Ñ€Ð°Ð±Ð»Ð¸! ðŸŽ‰"); game_over=True
    else:
        if not hit: current_turn="bot"; root.after(500,bot_turn)
    update_ui()

def bot_turn():
    global current_turn,game_over,bot_hits,bot_mode
    if game_over: return
    if bot_mode=="hunt" and bot_hits:
        last_hit=bot_hits[-1]
        neighbors=[(last_hit[0]+dx,last_hit[1]+dy) for dx,dy in [(0,1),(1,0),(0,-1),(-1,0)]]
        candidates=[(x,y) for x,y in neighbors if 0<=x<BOARD_SIZE and 0<=y<BOARD_SIZE and bot_display[x][y]=="~"]
        if candidates: x,y=random.choice(candidates)
        else: bot_hits.pop(); bot_mode="search"; bot_turn(); return
    else:
        candidates=[(i,j) for i in range(BOARD_SIZE) for j in range(BOARD_SIZE) if bot_display[i][j]=="~"]
        x,y=random.choice(candidates)
    hit=is_hit(player_board,x,y)
    bot_display[x][y]=player_board[x][y]="X" if hit else "O"
    is_ship_sunk(player_board,x,y,bot_display)
    if hit: bot_hits.append((x,y)); bot_mode="hunt"; root.after(500,bot_turn)
    else: current_turn="player"
    if all_ships_sunk(player_board):
        messagebox.showinfo("ÐŸÐ¾Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ"," Ð‘Ð¾Ñ‚ Ð¿Ð¾Ñ‚Ð¾Ð¿Ð¸Ð» Ð²ÑÐµ Ð²Ð°ÑˆÐ¸ ÐºÐ¾Ñ€Ð°Ð±Ð»Ð¸!"); game_over=True
    update_ui()

def place_ship_click(x,y):
    global ships_to_place,placing_ships
    if not placing_ships: return
    size=int(size_var.get())
    d="h" if dir_var.get()=="Ð“Ð¾Ñ€Ð¸Ð·Ð¾Ð½Ñ‚Ð°Ð»ÑŒÐ½Ð¾" else "v"
    if size not in ships_to_place: return
    if place_ship(player_board,x,y,size,d): ships_to_place.remove(size)
    update_ui()

def start_game():
    global placing_ships, current_turn, player_display, bot_display, game_over, ships_to_place
    if placing_ships and ships_to_place:
        total_ships_on_board = sum(row.count("S") for row in player_board)
        if total_ships_on_board != sum(SHIP_SIZES):
            messagebox.showinfo("ÐžÑˆÐ¸Ð±ÐºÐ°", "Ð Ð°ÑÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð²ÑÐµ ÐºÐ¾Ñ€Ð°Ð±Ð»Ð¸ Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð Ð°Ð½Ð´Ð¾Ð¼")
            return
        else:
            ships_to_place.clear()
    placing_ships = False
    current_turn = "player"
    game_over = False
    player_display = create_board()
    bot_display = create_board()
    for i in range(BOARD_SIZE):
        for j in range(BOARD_SIZE):
            bot_buttons[i][j].config(state="normal")
    update_ui()

def stop_game():
    global placing_ships,current_turn,game_over,player_board,bot_board,player_display,bot_display,ships_to_place
    placing_ships=True; current_turn="player"; game_over=False
    player_board=create_board(); bot_board=create_board(); player_display=create_board(); bot_display=create_board()
    ships_to_place=SHIP_SIZES.copy(); setup_bot_ships(); update_ui()

def create_ui():
    global player_buttons,bot_buttons,size_var,dir_var
    title=tk.Label(root,text=" ÐœÐžÐ Ð¡ÐšÐžÐ™ Ð‘ÐžÐ™ ",font=("Arial",16,"bold"),fg="darkblue")
    title.grid(row=0,column=0,columnspan=2,pady=10)
    pf=tk.Frame(root,bd=2,relief="ridge",bg="lightgray"); pf.grid(row=1,column=0,padx=10,pady=10)
    bf=tk.Frame(root,bd=2,relief="ridge",bg="lightgray"); bf.grid(row=1,column=1,padx=10,pady=10)
    tk.Label(pf,text="Ð’ÐÐ¨Ð• ÐŸÐžÐ›Ð•",bg="lightgray",font=("Arial",12,"bold")).grid(row=0,column=0,columnspan=11)
    tk.Label(bf,text="ÐŸÐžÐ›Ð• ÐŸÐ ÐžÐ¢Ð˜Ð’ÐÐ˜ÐšÐ",bg="lightgray",font=("Arial",12,"bold")).grid(row=0,column=0,columnspan=11)
    letters="ÐÐ‘Ð’Ð“Ð”Ð•Ð–Ð—Ð˜Ðš"
    for i in range(BOARD_SIZE):
        tk.Label(pf,text=letters[i],bg="lightgray").grid(row=1,column=i+1)
        tk.Label(bf,text=letters[i],bg="lightgray").grid(row=1,column=i+1)
        tk.Label(pf,text=str(i+1),bg="lightgray").grid(row=i+2,column=0)
        tk.Label(bf,text=str(i+1),bg="lightgray").grid(row=i+2,column=0)
    player_buttons=[]; bot_buttons=[]
    for i in range(BOARD_SIZE):
        pr,br=[],[]
        for j in range(BOARD_SIZE):
            btn=tk.Button(pf,width=3,height=1,command=lambda x=i,y=j: place_ship_click(x,y))
            btn.grid(row=i+2,column=j+1); pr.append(btn)
            btn=tk.Button(bf,width=3,height=1,command=lambda x=i,y=j: player_turn(x,y),state="disabled")
            btn.grid(row=i+2,column=j+1); br.append(btn)
        player_buttons.append(pr); bot_buttons.append(br)
    control_frame=tk.Frame(root,bg="lightyellow",bd=2,relief="groove"); control_frame.grid(row=2,column=0,columnspan=2,pady=10)
    tk.Label(control_frame,text="Ð Ð°Ð·Ð¼ÐµÑ€:",bg="lightyellow").grid(row=0,column=0)
    size_var=tk.StringVar(value=str(SHIP_SIZES[0]))
    tk.OptionMenu(control_frame,size_var,*sorted(set(SHIP_SIZES),reverse=True)).grid(row=0,column=1)
    tk.Label(control_frame,text="ÐÐ°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ:",bg="lightyellow").grid(row=0,column=2)
    dir_var=tk.StringVar(value="Ð“Ð¾Ñ€Ð¸Ð·Ð¾Ð½Ñ‚Ð°Ð»ÑŒÐ½Ð¾")
    tk.OptionMenu(control_frame,dir_var,"Ð“Ð¾Ñ€Ð¸Ð·Ð¾Ð½Ñ‚Ð°Ð»ÑŒÐ½Ð¾","Ð’ÐµÑ€Ñ‚Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾").grid(row=0,column=3)
    tk.Button(control_frame,text="Ð¡Ñ‚Ð°Ñ€Ñ‚",command=start_game,bg="lightgreen").grid(row=0,column=4,padx=5)
    tk.Button(control_frame,text="Ð Ð°Ð½Ð´Ð¾Ð¼",command=setup_player_random,bg="lightblue").grid(row=0,column=5,padx=5)
    tk.Button(control_frame,text="Ð¡Ð±Ñ€Ð¾Ñ",command=stop_game,bg="tomato").grid(row=0,column=6,padx=5)
    setup_bot_ships()
    update_ui()

def main():
    global root,player_board,bot_board,player_display,bot_display
    root=tk.Tk(); root.title("ÐœÐ¾Ñ€ÑÐºÐ¾Ð¹ Ð±Ð¾Ð¹"); root.configure(bg="aliceblue")
    player_board=create_board(); bot_board=create_board()
    player_display=create_board(); bot_display=create_board()
    create_ui(); root.mainloop()

if __name__=="__main__": main()
